000100 IDENTIFICATION DIVISION.
000200 PROGRAM-ID. FACTURETEST.
000300
000400 ENVIRONMENT DIVISION.
000500 CONFIGURATION SECTION.
000600 SPECIAL-NAMES.
000700     DECIMAL-POINT IS COMMA.
000800
000900 INPUT-OUTPUT SECTION.
001000 FILE-CONTROL.
001100     SELECT FACTURE-FILE ASSIGN TO FACTURES
001200     ORGANIZATION IS SEQUENTIAL
001300     ACCESS MODE IS SEQUENTIAL
001400     FILE STATUS IS WS-FACTURE-STATUS.
001500
001600     SELECT SYSIN-FILE ASSIGN TO SYSIN
001700     ORGANIZATION IS SEQUENTIAL
001800     ACCESS MODE IS SEQUENTIAL
001900     FILE STATUS IS WS-SYSIN-STATUS.
002000
002100 DATA DIVISION.
002200 FILE SECTION.
002300 FD  FACTURE-FILE
002400     RECORDING MODE IS F
002500     RECORD CONTAINS 132 CHARACTERS.
002600 01  FACTURE-RECORD           PIC X(132).
002700
002800 FD  SYSIN-FILE
002900     RECORDING MODE IS F
003000     RECORD CONTAINS 80 CHARACTERS.
003100 01  SYSIN-RECORD             PIC X(80).
003200
003300 WORKING-STORAGE SECTION.
003400 77 WS-FACTURE-STATUS         PIC XX.
003500 77 WS-SYSIN-STATUS           PIC XX.
003600 77 WS-EOF-FLAG               PIC X VALUE 'N'.
003700     88 EOF-FACTURE           VALUE 'Y'.
003800 77 WS-LINE-COUNT             PIC 999 VALUE ZERO.
003900 77 WS-INVOICE-COUNT          PIC 9 VALUE ZERO.
004000
004100* VARIABLES POUR LES TESTS
004200 77 WS-EXPECTED-LINES         PIC 999.
004300 77 WS-EXPECTED-INVOICES      PIC 9.
004400 01 LIB                       PIC X(30).
004500 01 L-SEP                     PIC X(50) VALUE ALL '*'.
004600
004700* VARIABLES POUR ANALYSER LE CONTENU
004800 77 WS-COMPANY-FOUND          PIC X VALUE 'N'.
004900     88 COMPANY-FOUND         VALUE 'Y'.
005000 77 WS-TOTAL-FOUND            PIC X VALUE 'N'.
005100     88 TOTAL-FOUND           VALUE 'Y'.
005200 77 WS-TVA-FOUND              PIC X VALUE 'N'.
005300     88 TVA-FOUND             VALUE 'Y'.
005400
005500 LINKAGE SECTION.
005600 COPY TESTCONT.
005700
005800 PROCEDURE DIVISION USING TEST-CONTEXT.
005900
006000     DISPLAY "=== DEBUT DES TESTS FACTURE ==="
006100     PERFORM TEST-FACTURE-FILE-EXISTS
006200     PERFORM TEST-FACTURE-CONTENT
006300     PERFORM TEST-FACTURE-STRUCTURE
006400     PERFORM TEST-FACTURE-COMPANIES
006500
006600     DISPLAY "=== RESUME FINAL ==="
006700     DISPLAY 'TESTS: ' TESTS-RUN ' OK: ' PASSES ' KO: ' FAILURES
006800     DISPLAY L-SEP
006900
007000     GOBACK.
007100
007200 TEST-FACTURE-FILE-EXISTS.
007300     MOVE 'TEST-FACTURE-FILE-EXISTS' TO LIB
007400     ADD 1 TO TESTS-RUN
007500
007600     OPEN INPUT FACTURE-FILE
007700     IF WS-FACTURE-STATUS = '00'
007800         ADD 1 TO PASSES
007900         DISPLAY '******** ' LIB ' - PASSED *********'
008000         CLOSE FACTURE-FILE
008100     ELSE
008200         ADD 1 TO FAILURES
008300         DISPLAY 'FAILED : ' LIB
008400         DISPLAY 'FILE STATUS: ' WS-FACTURE-STATUS
008500         DISPLAY 'FICHIER FACTURES NON TROUVE'
008600     END-IF
008700     DISPLAY L-SEP.
008800
008900 TEST-FACTURE-CONTENT.
009000     MOVE 'TEST-FACTURE-CONTENT' TO LIB
009100     ADD 1 TO TESTS-RUN
009200
009300     OPEN INPUT FACTURE-FILE
009400     IF WS-FACTURE-STATUS NOT = '00'
009500         ADD 1 TO FAILURES
009600         DISPLAY 'FAILED : ' LIB
009700         DISPLAY 'IMPOSSIBLE D OUVRIR LE FICHIER'
009800         GO TO TEST-FACTURE-CONTENT-EXIT
009900     END-IF
010000
010100     MOVE ZERO TO WS-LINE-COUNT
010200     MOVE 'N' TO WS-EOF-FLAG
010300
010400     PERFORM UNTIL EOF-FACTURE
010500         READ FACTURE-FILE
010600             AT END
010700                 SET EOF-FACTURE TO TRUE
010800             NOT AT END
010900                 ADD 1 TO WS-LINE-COUNT
011000* RECHERCHE DES ELEMENTS CLES
011100                 IF FACTURE-RECORD(1:12) = '|    ABC Comp'
011200                     SET COMPANY-FOUND TO TRUE
011300                 END-IF
011400                 IF FACTURE-RECORD(84:15) = 'TOTAL        :'
011500                     SET TOTAL-FOUND TO TRUE
011600                 END-IF
011700                 IF FACTURE-RECORD(78:11) = 'SALES TAX ('
011800                     SET TVA-FOUND TO TRUE
011900                 END-IF
012000         END-READ
012100     END-PERFORM
012200
012300     IF WS-LINE-COUNT > 20 AND COMPANY-FOUND AND 
012400        TOTAL-FOUND AND TVA-FOUND
012500         ADD 1 TO PASSES
012600         DISPLAY '******** ' LIB ' - PASSED *********'
012700         DISPLAY 'LIGNES FACTURE: ' WS-LINE-COUNT
012800         DISPLAY 'ELEMENTS CLES TROUVES'
012900     ELSE
013000         ADD 1 TO FAILURES
013100         DISPLAY 'FAILED : ' LIB
013200         DISPLAY 'LIGNES: ' WS-LINE-COUNT
013300         IF NOT COMPANY-FOUND
013400             DISPLAY 'COMPANY NOT FOUND'
013500         END-IF
013600         IF NOT TOTAL-FOUND
013700             DISPLAY 'TOTAL NOT FOUND'
013800         END-IF
013900         IF NOT TVA-FOUND
014000             DISPLAY 'TVA NOT FOUND'
014100         END-IF
014200     END-IF
014300
014400     CLOSE FACTURE-FILE
014500 TEST-FACTURE-CONTENT-EXIT.
014600     DISPLAY L-SEP.
014700
014800 TEST-FACTURE-STRUCTURE.
014900     MOVE 'TEST-FACTURE-STRUCTURE' TO LIB
015000     ADD 1 TO TESTS-RUN
015100
015200     OPEN INPUT FACTURE-FILE
015300     IF WS-FACTURE-STATUS NOT = '00'
015400         ADD 1 TO FAILURES
015500         DISPLAY 'FAILED : ' LIB
015600         DISPLAY 'IMPOSSIBLE D OUVRIR LE FICHIER'
015700         GO TO TEST-FACTURE-STRUCTURE-EXIT
015800     END-IF
015900
016000* VERIFICATION DES CADRES
016100     READ FACTURE-FILE
016200         AT END
016300             ADD 1 TO FAILURES
016400             DISPLAY 'FAILED : ' LIB
016500             DISPLAY 'FICHIER VIDE'
016600             GO TO TEST-FACTURE-STRUCTURE-CLOSE
016700         NOT AT END
016800* VERIFICATION QUE LA PREMIERE LIGNE EST UN CADRE
016900             IF FACTURE-RECORD(1:1) = '+' AND
017000                FACTURE-RECORD(119:1) = '+'
017100                 ADD 1 TO PASSES
017200                 DISPLAY '******** ' LIB ' - PASSED *********'
017300                 DISPLAY 'STRUCTURE CADRE OK'
017400             ELSE
017500                 ADD 1 TO FAILURES
017600                 DISPLAY 'FAILED : ' LIB
017700                 DISPLAY 'STRUCTURE CADRE INCORRECTE'
017800                 DISPLAY 'PREMIERE LIGNE: [' FACTURE-RECORD ']'
017900             END-IF
018000     END-READ
018100
018200 TEST-FACTURE-STRUCTURE-CLOSE.
018300     CLOSE FACTURE-FILE
018400 TEST-FACTURE-STRUCTURE-EXIT.
018500     DISPLAY L-SEP.
018600
018700 TEST-FACTURE-COMPANIES.
018800     MOVE 'TEST-FACTURE-COMPANIES' TO LIB
018900     ADD 1 TO TESTS-RUN
019000
019100     OPEN INPUT FACTURE-FILE
019200     IF WS-FACTURE-STATUS NOT = '00'
019300         ADD 1 TO FAILURES
019400         DISPLAY 'FAILED : ' LIB
019500         DISPLAY 'IMPOSSIBLE D OUVRIR LE FICHIER'
019600         GO TO TEST-FACTURE-COMPANIES-EXIT
019700     END-IF
019800
019900     MOVE ZERO TO WS-INVOICE-COUNT
020000     MOVE 'N' TO WS-EOF-FLAG
020100
020200* COMPTAGE DES FACTURES EN CHERCHANT LES CADRES DE DEBUT
020300     PERFORM UNTIL EOF-FACTURE
020400         READ FACTURE-FILE
020500             AT END
020600                 SET EOF-FACTURE TO TRUE
020700             NOT AT END
020800* DETECTION D UNE NOUVELLE FACTURE PAR LE CADRE HAUT
020900                 IF FACTURE-RECORD(1:1) = '+' AND
021000                    FACTURE-RECORD(2:117) = ALL '-' AND
021100                    FACTURE-RECORD(119:1) = '+'
021200                     ADD 1 TO WS-INVOICE-COUNT
021300                 END-IF
021400         END-READ
021500     END-PERFORM
021600
021700     MOVE 3 TO WS-EXPECTED-INVOICES
021800     IF WS-INVOICE-COUNT = WS-EXPECTED-INVOICES
021900         ADD 1 TO PASSES
022000         DISPLAY '******** ' LIB ' - PASSED *********'
022100         DISPLAY 'NOMBRE DE FACTURES: ' WS-INVOICE-COUNT
022200     ELSE
022300         ADD 1 TO FAILURES
022400         DISPLAY 'FAILED : ' LIB
022500         DISPLAY 'EXPECTED INVOICES: ' WS-