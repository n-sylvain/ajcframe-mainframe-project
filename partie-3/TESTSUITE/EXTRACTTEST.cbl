000100 IDENTIFICATION DIVISION.
000200 PROGRAM-ID. EXTRACTTEST.
000300
000400 ENVIRONMENT DIVISION.
000500 CONFIGURATION SECTION.
000600 SPECIAL-NAMES.
000700     DECIMAL-POINT IS COMMA.
000800
000900 INPUT-OUTPUT SECTION.
001000 FILE-CONTROL.
001100     SELECT EXTRACT-FILE ASSIGN TO EXTRACT
001200     ORGANIZATION IS SEQUENTIAL
001300     ACCESS MODE IS SEQUENTIAL
001400     FILE STATUS IS WS-FILE-STATUS.
001500
001600 DATA DIVISION.
001700 FILE SECTION.
001800 FD  EXTRACT-FILE
001900     RECORDING MODE IS F
002000     RECORD CONTAINS 280 CHARACTERS.
002100 01  EXTRACT-RECORD.
002200     05 EXT-COMPANY           PIC X(30).
002300     05 EXT-ADDRESS           PIC X(100).
002400     05 EXT-CITY              PIC X(20).
002500     05 EXT-ZIP               PIC X(5).
002600     05 EXT-STATE             PIC X(2).
002700     05 EXT-O-NO              PIC 9(3).
002800     05 EXT-ODATE-ISO         PIC X(10).
002900     05 EXT-DNAME             PIC X(20).
003000     05 EXT-LNAME             PIC X(20).
003100     05 EXT-FNAME             PIC X(20).
003200     05 EXT-P-NO              PIC X(3).
003300     05 EXT-DESCRIPTION       PIC X(30).
003400     05 EXT-QUANTITY          PIC 9(2).
003500     05 EXT-PRICE             PIC 9(3)V99.
003600     05 EXT-LINE-TOTAL        PIC 9(5)V99.
003700     05 FILLER                PIC X(1).
003800
003900 WORKING-STORAGE SECTION.
004000 77 WS-FILE-STATUS            PIC XX.
004100 77 WS-EOF-FLAG               PIC X VALUE 'N'.
004200     88 EOF-EXTRACT           VALUE 'Y'.
004300 77 WS-RECORD-COUNT           PIC 999 VALUE ZERO.
004400
004500* VARIABLES POUR LES TESTS
004600 77 WS-EXPECTED-RECORDS       PIC 999.
004700 01 LIB                       PIC X(30).
004800 01 L-SEP                     PIC X(50) VALUE ALL '*'.
004900
005000* PREMIERE LIGNE ATTENDUE (ABC COMPANY - P01)
005100 01 EXPECTED-RECORD-1.
005200     05 FILLER                PIC X(30) VALUE 'ABC Company'.
005300     05 FILLER                PIC X(100) VALUE '123 Main Street'.
005400     05 FILLER                PIC X(20) VALUE 'New York'.
005500     05 FILLER                PIC X(5) VALUE '10001'.
005600     05 FILLER                PIC X(2) VALUE 'NY'.
005700     05 FILLER                PIC 9(3) VALUE 101.
005800     05 FILLER                PIC X(10) VALUE '2022-02-15'.
005900     05 FILLER                PIC X(20) VALUE 'Sales'.
006000     05 FILLER                PIC X(20) VALUE 'Doe'.
006100     05 FILLER                PIC X(20) VALUE 'John'.
006200     05 FILLER                PIC X(3) VALUE 'P01'.
006300     05 FILLER                PIC X(30) VALUE 'Mouse Bluetooth'.
006400     05 FILLER                PIC 9(2) VALUE 10.
006500     05 FILLER                PIC 9(3)V99 VALUE 025,99.
006600     05 FILLER                PIC 9(5)V99 VALUE 00259,90.
006700     05 FILLER                PIC X(1) VALUE SPACE.
006800
006900 LINKAGE SECTION.
007000 COPY TESTCONT.
007100
007200 PROCEDURE DIVISION USING TEST-CONTEXT.
007300
007400     DISPLAY "=== DEBUT DES TESTS EXTRACT ==="
007500     PERFORM TEST-EXTRACT-FILE-EXISTS
007600     PERFORM TEST-EXTRACT-RECORD-COUNT  
007700     PERFORM TEST-EXTRACT-FIRST-RECORD
007800     PERFORM TEST-EXTRACT-STRUCTURE
007900
008000     DISPLAY "=== RESUME FINAL ==="
008100     DISPLAY 'TESTS: ' TESTS-RUN ' OK: ' PASSES ' KO: ' FAILURES
008200     DISPLAY L-SEP
008300
008400     GOBACK.
008500
008600 TEST-EXTRACT-FILE-EXISTS.
008700     MOVE 'TEST-EXTRACT-FILE-EXISTS' TO LIB
008800     ADD 1 TO TESTS-RUN
008900
009000     OPEN INPUT EXTRACT-FILE
009100     IF WS-FILE-STATUS = '00'
009200         ADD 1 TO PASSES
009300         DISPLAY '******** ' LIB ' - PASSED *********'
009400         CLOSE EXTRACT-FILE
009500     ELSE
009600         ADD 1 TO FAILURES
009700         DISPLAY 'FAILED : ' LIB
009800         DISPLAY 'FILE STATUS: ' WS-FILE-STATUS
009900         DISPLAY 'FICHIER EXTRACT NON TROUVE OU INACCESSIBLE'
010000     END-IF
010100     DISPLAY L-SEP.
010200
010300 TEST-EXTRACT-RECORD-COUNT.
010400     MOVE 'TEST-EXTRACT-RECORD-COUNT' TO LIB
010500     MOVE 4 TO WS-EXPECTED-RECORDS
010600     ADD 1 TO TESTS-RUN
010700
010800     OPEN INPUT EXTRACT-FILE
010900     IF WS-FILE-STATUS NOT = '00'
011000         ADD 1 TO FAILURES
011100         DISPLAY 'FAILED : ' LIB
011200         DISPLAY 'IMPOSSIBLE D OUVRIR LE FICHIER'
011300         GO TO TEST-EXTRACT-RECORD-COUNT-EXIT
011400     END-IF
011500
011600     MOVE ZERO TO WS-RECORD-COUNT
011700     MOVE 'N' TO WS-EOF-FLAG
011800
011900     PERFORM UNTIL EOF-EXTRACT
012000         READ EXTRACT-FILE
012100             AT END
012200                 SET EOF-EXTRACT TO TRUE
012300             NOT AT END
012400                 ADD 1 TO WS-RECORD-COUNT
012500         END-READ
012600     END-PERFORM
012700
012800     IF WS-RECORD-COUNT = WS-EXPECTED-RECORDS
012900         ADD 1 TO PASSES
013000         DISPLAY '******** ' LIB ' - PASSED *********'
013100         DISPLAY 'NOMBRE DE RECORDS: ' WS-RECORD-COUNT
013200     ELSE
013300         ADD 1 TO FAILURES
013400         DISPLAY 'FAILED : ' LIB
013500         DISPLAY 'EXPECTED: ' WS-EXPECTED-RECORDS
013600         DISPLAY 'ACTUAL  : ' WS-RECORD-COUNT
013700     END-IF
013800
013900     CLOSE EXTRACT-FILE
014000 TEST-EXTRACT-RECORD-COUNT-EXIT.
014100     DISPLAY L-SEP.
014200
014300 TEST-EXTRACT-FIRST-RECORD.
014400     MOVE 'TEST-EXTRACT-FIRST-RECORD' TO LIB
014500     ADD 1 TO TESTS-RUN
014600
014700     OPEN INPUT EXTRACT-FILE
014800     IF WS-FILE-STATUS NOT = '00'
014900         ADD 1 TO FAILURES
015000         DISPLAY 'FAILED : ' LIB
015100         DISPLAY 'IMPOSSIBLE D OUVRIR LE FICHIER'
015200         GO TO TEST-EXTRACT-FIRST-RECORD-EXIT
015300     END-IF
015400
015500     READ EXTRACT-FILE
015600         AT END
015700             ADD 1 TO FAILURES
015800             DISPLAY 'FAILED : ' LIB
015900             DISPLAY 'FICHIER VIDE'
016000             GO TO TEST-EXTRACT-FIRST-RECORD-CLOSE
016100         NOT AT END
016200             IF EXTRACT-RECORD = EXPECTED-RECORD-1
016300                 ADD 1 TO PASSES
016400                 DISPLAY '******** ' LIB ' - PASSED *********'
016500             ELSE
016600                 ADD 1 TO FAILURES
016700                 DISPLAY 'FAILED : ' LIB
016800                 DISPLAY 'FIRST RECORD MISMATCH'
016900                 DISPLAY 'COMPANY: [' EXT-COMPANY ']'
017000                 DISPLAY 'ORDER  : [' EXT-O-NO ']'
017100                 DISPLAY 'PRODUCT: [' EXT-P-NO ']'
017200             END-IF
017300     END-READ
017400
017500 TEST-EXTRACT-FIRST-RECORD-CLOSE.
017600     CLOSE EXTRACT-FILE
017700 TEST-EXTRACT-FIRST-RECORD-EXIT.
017800     DISPLAY L-SEP.
017900
018000 TEST-EXTRACT-STRUCTURE.
018100     MOVE 'TEST-EXTRACT-STRUCTURE' TO LIB
018200     ADD 1 TO TESTS-RUN
018300
018400     OPEN INPUT EXTRACT-FILE
018500     IF WS-FILE-STATUS NOT = '00'
018600         ADD 1 TO FAILURES
018700         DISPLAY 'FAILED : ' LIB
018800         DISPLAY 'IMPOSSIBLE D OUVRIR LE FICHIER'
018900         GO TO TEST-EXTRACT-STRUCTURE-EXIT
019000     END-IF
019100
019200* VERIFICATION DE LA STRUCTURE DES DONNEES
019300     READ EXTRACT-FILE
019400         AT END
019500             ADD 1 TO FAILURES
019600             DISPLAY 'FAILED : ' LIB
019700             DISPLAY 'FICHIER VIDE'
019800             GO TO TEST-EXTRACT-STRUCTURE-CLOSE
019900         NOT AT END
020000* VERIFICATION DES CHAMPS CRITIQUES
020100             IF EXT-O-NO IS NUMERIC AND
020200                EXT-QUANTITY IS NUMERIC AND
020300                EXT-PRICE IS NUMERIC AND
020400                EXT-LINE-TOTAL IS NUMERIC
020500                 ADD 1 TO PASSES
020600                 DISPLAY '******** ' LIB ' - PASSED *********'
020700                 DISPLAY 'STRUCTURE NUMERIQUE OK'
020800             ELSE
020900                 ADD 1 TO FAILURES
021000                 DISPLAY 'FAILED : ' LIB
021100                 DISPLAY 'CHAMPS NUMERIQUES INVALIDES'
021200             END-IF
021300     END-READ
021400
021500 TEST-EXTRACT-STRUCTURE-CLOSE.
021600     CLOSE EXTRACT-FILE
021700 TEST-EXTRACT-STRUCTURE-EXIT.
021800     DISPLAY L-SEP.